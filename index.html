<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="light" data-color="blue">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه نویسنده هوشمند</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @font-face {
            font-family: 'B Titr';
            src: url('https://cdn.fontcdn.ir/Font/Persian/Titr/Titr.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'B Nazanin';
            src: url('https://cdn.fontcdn.ir/Font/Persian/Nazanin/Nazanin.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: rgba(0, 0, 0, 0.05);
            --input-bg: #ffffff;
            --btn-text: #495057;
            --btn-border: #e9ecef;
            --btn-hover-bg: #f8f9fa;
            --btn-hover-border: #dee2e6;
            --btn-hover-text: #212529;
            --result-bg: #f8f9fa;
            --primary-color: #0d6efd;
            --primary-hover: #0b5ed7;
        }

        [data-theme="dark"] {
            --bg-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: #2b3035;
            --btn-text: #e9ecef;
            --btn-border: #495057;
            --btn-hover-bg: #343a40;
            --btn-hover-border: #6c757d;
            --btn-hover-text: #ffffff;
            --result-bg: #2b3035;
        }

        [data-color="blue"] { --primary-color: #0d6efd; --primary-hover: #0b5ed7; }
        [data-color="red"] { --primary-color: #dc3545; --primary-hover: #c82333; }
        [data-color="green"] { --primary-color: #198754; --primary-hover: #157347; }

        body {
            font-family: 'Vazirmatn', 'B Nazanin', 'Tahoma', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 0;
            margin: 0;
        }

        h1, h2, h3, h4, h5, h6, .card-header, .btn, #generate-btn {
            font-family: 'B Titr', 'Vazirmatn', 'Tahoma', sans-serif;
            letter-spacing: 0.5px;
        }

        p, div, span, input, textarea, label, .form-control, #result-text, .history-item {
            font-family: 'B Nazanin', 'Vazirmatn', 'Tahoma', sans-serif;
            letter-spacing: 0.3px;
        }

        .card {
            border-radius: 10px;
            border: none;
            overflow: hidden;
            background-color: var(--card-bg);
            transition: background-color 0.3s ease;
        }

        .card-header {
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }

        .btn-outline-secondary {
            border-color: var(--btn-border);
            color: var(--btn-text);
        }

        .btn-outline-secondary:hover {
            background-color: var(--btn-hover-bg);
            border-color: var(--btn-hover-border);
            color: var(--btn-hover-text);
        }

        .btn-outline-secondary.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .connected { background-color: #28a745; box-shadow: 0 0 5px #28a745; }
        .disconnected { background-color: #dc3545; box-shadow: 0 0 5px #dc3545; }
        .connecting {
            background-color: #ffc107;
            box-shadow: 0 0 5px #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        #result-text {
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.8;
            background-color: var(--result-bg);
        }

        .format-btn.active, .tone-btn.active, .length-btn.active, .language-btn.active, .model-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        #history-container { margin-bottom: 2rem; }

        .history-item {
            transition: background-color 0.2s;
            border-left: none;
            border-right: none;
        }

        .history-item:hover { background-color: rgba(0, 0, 0, 0.02); }
        [data-theme="dark"] .history-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .history-item:first-child { border-top: none; }
        .badge { font-weight: normal; }

        .highlight {
            background-color: #ffff99;
            font-size: 1.1rem;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .theme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover { transform: scale(1.1); }

        .color-options {
            display: none;
            flex-wrap: wrap;
            gap: 5px;
            width: 150px;
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .color-options.show { display: flex; }

        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-option:hover { transform: scale(1.2); }

        [data-theme="dark"] .text-muted { color: #adb5bd !important; }
        [data-theme="dark"] small { color: #ced4da !important; }
        [data-theme="dark"] .btn-outline-danger { color: #f8d7da; border-color: #dc3545; }
        [data-theme="dark"] .btn-outline-primary { color: #cfe2ff; border-color: var(--primary-color); }
        [data-theme="dark"] .btn-outline-success { color: #d1e7dd; border-color: #198754; }
        [data-theme="dark"] .btn-outline-secondary { color: #e9ecef; border-color: #6c757d; }
        [data-theme="dark"] .card-header h5,
        [data-theme="dark"] .card-header h1,
        [data-theme="dark"] label,
        [data-theme="dark"] .form-label,
        [data-theme="dark"] .mb-0 { color: #e9ecef; }
        [data-theme="dark"] #result-text { color: #e9ecef; }
        [data-theme="dark"] .form-control {
            color: #e9ecef;
            background-color: var(--input-bg);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .bg-light { background-color: var(--result-bg) !important; }

        .container {
            padding: 15px;
            max-width: 100%;
        }

        .model-api-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .api-key-input {
            flex-grow: 1;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .col-md-6.offset-md-3 {
                padding: 0 10px;
                width: 100%;
            }
            .card { border-radius: 8px; }
            .btn { padding: 0.375rem 0.5rem; font-size: 0.875rem; }
            .theme-switcher { top: 10px; right: 10px; }
            .model-api-container { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h1 class="text-center mb-0 fw-bold">نوشتن خلاق</h1>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label for="topic" class="form-label">موضوعی که می‌خواهید بنویسید</label>
                            <textarea id="topic" class="form-control" rows="3" placeholder="برای ایجاد پیش‌نویس، Enter را فشار دهید"></textarea>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-layout-text-window me-2"></i>
                                <h5 class="mb-0">قالب</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary format-btn" data-format="essay">انشا</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="paragraph">پاراگراف</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="email">پست الکترونیکی</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="reflection">اندیشه</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="blog">پست وبلاگ</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="outline">طرح کلی</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="marketing">تبلیغات بازاریابی</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="comment">اظهار نظر</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="message">پیام</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="twitter">توییت</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-emoji-smile me-2"></i>
                                <h5 class="mb-0">لحن</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary tone-btn" data-tone="formal">رسمی</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="casual">گاه‌به‌گاه</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="professional">حرفه‌ای</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="creative">مشتاق</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="informative">اطلاعاتی</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="humorous">خنده‌دار</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-text-paragraph me-2"></i>
                                <h5 class="mb-0">طول</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary length-btn" data-length="short">کوتاه</button>
                                <button class="btn btn-outline-secondary length-btn" data-length="medium">متوسط</button>
                                <button class="btn btn-outline-secondary length-btn" data-length="long">طولانی</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-gear me-2"></i>
                                <h5 class="mb-0">تنظیمات پیشرفته</h5>
                            </div>
                            <div class="mb-2">
                                <label for="creativity" class="form-label small">درجه خلاقیت (0 تا 2): <span id="creativity-value">0.5</span></label>
                                <input type="range" id="creativity" class="form-range" min="0" max="2" step="0.01" value="0.5">
                            </div>
                            <div>
                                <label for="max-words" class="form-label small">حداکثر کلمات:</label>
                                <input type="number" id="max-words" class="form-control" min="50" value="500">
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-translate me-2"></i>
                                <h5 class="mb-0">زبان</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary language-btn active" data-lang="fa">فارسی</button>
                                <button class="btn btn-outline-secondary language-btn" data-lang="en">English</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-robot me-2"></i>
                                <h5 class="mb-0">مدل هوش مصنوعی</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary model-btn active" data-model="lm-studio">LM Studio <span class="status-dot" id="status-lm-studio"></span></button>
                                <button class="btn btn-outline-secondary model-btn" data-model="gemini">Gemini <span class="status-dot" id="status-gemini"></span></button>
                                <button class="btn btn-outline-secondary model-btn" data-model="openrouter">OpenRouter <span class="status-dot" id="status-openrouter"></span></button>
                            </div>
                            <div class="mt-3">
                                <div class="model-api-container">
                                    <input type="text" id="api-key-gemini" class="form-control api-key-input" placeholder="کلید API برای Gemini">
                                    <button class="btn btn-sm btn-primary verify-api-btn" data-model="gemini">تأیید</button>
                                </div>
                                <div class="model-api-container">
                                    <input type="text" id="api-key-openrouter" class="form-control api-key-input" placeholder="کلید API برای OpenRouter">
                                    <button class="btn btn-sm btn-primary verify-api-btn" data-model="openrouter">تأیید</button>
                                </div>
                                <div class="model-api-container">
                                    <select id="openrouter-model" class="form-control" style="width: 100%;"></select>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button id="generate-btn" class="btn btn-primary py-3 fw-bold">ایجاد پیش‌نویس</button>
                            <button id="compare-btn" class="btn btn-outline-primary py-2">مقایسه مدل‌ها</button>
                        </div>

                        <div class="mt-3 d-flex align-items-center">
                            <div class="connection-status me-2">
                                <span id="status-indicator" class="status-dot disconnected"></span>
                            </div>
                            <small id="connection-text">اتصال به مدل هوش مصنوعی: قطع</small>
                        </div>
                    </div>
                </div>

                <div id="result-container" class="card shadow-sm mt-4 d-none">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">نتیجه:</h5>
                        <div>
                            <button id="copy-btn" class="btn btn-sm btn-outline-secondary me-2"><i class="bi bi-clipboard"></i> کپی</button>
                            <button id="download-pdf-btn" class="btn btn-sm btn-outline-secondary me-2"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                            <button id="download-doc-btn" class="btn btn-sm btn-outline-secondary me-2"><i class="bi bi-file-word"></i> Word</button>
                            <button id="analyze-btn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-bar-chart"></i> تحلیل</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="result-text" class="p-3 bg-light rounded"></div>
                        <div id="comparison-results" class="mt-3 d-none"></div>
                        <div id="analysis-results" class="mt-3 text-muted small d-none"></div>
                    </div>
                </div>
            </div>

            <div id="history-container" class="card shadow-sm mt-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">تاریخچه</h5>
                    <div>
                        <input type="text" id="history-search" class="form-control form-control-sm d-inline-block w-auto me-2" placeholder="جستجو...">
                        <button id="backup-history-btn" class="btn btn-sm btn-outline-success me-2"><i class="bi bi-download"></i> بکاپ</button>
                        <button id="restore-history-btn" class="btn btn-sm btn-outline-success me-2"><i class="bi bi-upload"></i> بازیابی</button>
                        <button id="clear-history-btn" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> پاک کردن</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="history-list" class="list-group list-group-flush">
                        <div class="list-group-item text-center text-muted py-4" id="no-history-message">تاریخچه‌ای موجود نیست</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="theme-switcher">
        <button class="theme-toggle" id="theme-toggle">
            <i class="bi bi-sun-fill" id="theme-icon"></i>
        </button>
        <div class="color-options" id="color-options">
            <div class="color-option" data-color="blue" style="background-color: #0d6efd;"></div>
            <div class="color-option" data-color="red" style="background-color: #dc3545;"></div>
            <div class="color-option" data-color="green" style="background-color: #198754;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const topicInput = document.getElementById('topic');
            const generateBtn = document.getElementById('generate-btn');
            const compareBtn = document.getElementById('compare-btn');
            const resultContainer = document.getElementById('result-container');
            const resultText = document.getElementById('result-text');
            const comparisonResults = document.getElementById('comparison-results');
            const analysisResults = document.getElementById('analysis-results');
            const copyBtn = document.getElementById('copy-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const downloadDocBtn = document.getElementById('download-doc-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const connectionText = document.getElementById('connection-text');
            const formatBtns = document.querySelectorAll('.format-btn');
            const toneBtns = document.querySelectorAll('.tone-btn');
            const lengthBtns = document.querySelectorAll('.length-btn');
            const languageBtns = document.querySelectorAll('.language-btn');
            const modelBtns = document.querySelectorAll('.model-btn');
            const verifyApiBtns = document.querySelectorAll('.verify-api-btn');
            const historyList = document.getElementById('history-list');
            const historySearch = document.getElementById('history-search');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const backupHistoryBtn = document.getElementById('backup-history-btn');
            const restoreHistoryBtn = document.getElementById('restore-history-btn');
            const noHistoryMessage = document.getElementById('no-history-message');
            const creativityInput = document.getElementById('creativity');
            const creativityValue = document.getElementById('creativity-value');
            const maxWordsInput = document.getElementById('max-words');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const colorOptions = document.getElementById('color-options');
            const colorOptionBtns = document.querySelectorAll('.color-option');
            const openRouterModelSelect = document.getElementById('openrouter-model');

            let selectedFormat = '';
            let selectedTone = '';
            let selectedLength = '';
            let selectedLanguage = 'fa';
            let selectedModel = 'lm-studio';
            let selectedOpenRouterModel = 'openai/gpt-3.5-turbo'; // پیش‌فرض
            let historyItems = [];
            let apiKeys = {
                'gemini': localStorage.getItem('api-key-gemini') || '',
                'openrouter': localStorage.getItem('api-key-openrouter') || ''
            };
            let isLmConnected = false;
            let isGeminiConnected = false;
            let isOpenRouterConnected = false;
            let currentStream = null;
            let abortController = null;

            const apiEndpoints = {
                'lm-studio': 'http://localhost:1234/v1/completions',
                'gemini': 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
                'openrouter': 'https://openrouter.ai/api/v1/chat/completions'
            };

            const { jsPDF } = window.jspdf;

            document.getElementById('api-key-gemini').value = apiKeys['gemini'];
            document.getElementById('api-key-openrouter').value = apiKeys['openrouter'];

            init();

            function init() {
                checkAllConnections();
                loadHistory();
                loadOpenRouterModels();
                setupEventListeners();
            }

            async function checkConnection(model) {
                const statusDot = document.getElementById(`status-${model}`);
                statusDot.className = 'status-dot connecting';

                if (model === 'lm-studio') {
                    try {
                        const response = await fetch('http://localhost:1234/v1/models');
                        if (response.ok) {
                            isLmConnected = true;
                            statusDot.className = 'status-dot connected';
                            updateStatus(model, true, 'اتصال موفق');
                        } else {
                            throw new Error('اتصال برقرار نشد');
                        }
                    } catch (error) {
                        isLmConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'عدم اتصال به LM Studio');
                    }
                } else if (model === 'gemini') {
                    const apiKey = apiKeys['gemini'];
                    if (!apiKey) {
                        isGeminiConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'کلید API Gemini وارد نشده');
                        return;
                    }
                    try {
                        const response = await fetch(`${apiEndpoints[model]}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: 'تست' }] }] })
                        });
                        if (response.ok) {
                            isGeminiConnected = true;
                            statusDot.className = 'status-dot connected';
                            updateStatus(model, true, 'اتصال موفق');
                        } else {
                            throw new Error('اتصال برقرار نشد');
                        }
                    } catch (error) {
                        isGeminiConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'عدم اتصال به Gemini');
                    }
                } else if (model === 'openrouter') {
                    const apiKey = apiKeys['openrouter'];
                    if (!apiKey) {
                        isOpenRouterConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'کلید API OpenRouter وارد نشده');
                        return;
                    }
                    try {
                        const response = await fetch('https://openrouter.ai/api/v1/models', {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${apiKey}` }
                        });
                        if (response.ok) {
                            isOpenRouterConnected = true;
                            statusDot.className = 'status-dot connected';
                            updateStatus(model, true, 'اتصال موفق');
                            loadOpenRouterModels();
                        } else {
                            throw new Error('اتصال برقرار نشد');
                        }
                    } catch (error) {
                        isOpenRouterConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'عدم اتصال به OpenRouter');
                    }
                }
            }

            function updateStatus(model, isConnected, message) {
                if (model === selectedModel) {
                    statusIndicator.className = `status-dot ${isConnected ? 'connected' : 'disconnected'}`;
                    connectionText.textContent = `اتصال به مدل هوش مصنوعی: ${isConnected ? 'متصل' : `قطع - ${message}`}`;
                }
            }

            function checkAllConnections() {
                checkConnection('lm-studio');
                checkConnection('gemini');
                checkConnection('openrouter');
                setInterval(() => {
                    checkConnection('lm-studio');
                    checkConnection('gemini');
                    checkConnection('openrouter');
                }, 20000);
            }

            async function loadOpenRouterModels() {
                const apiKey = apiKeys['openrouter'];
                if (!apiKey) {
                    openRouterModelSelect.innerHTML = '<option value="">ابتدا کلید API را وارد کنید</option>';
                    return;
                }

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/models', {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    if (!response.ok) throw new Error('خطا در گرفتن لیست مدل‌ها');

                    const data = await response.json();
                    const models = data.data;
                    openRouterModelSelect.innerHTML = '<option value="">یک مدل انتخاب کنید</option>';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name || model.id;
                        openRouterModelSelect.appendChild(option);
                    });
                    openRouterModelSelect.value = selectedOpenRouterModel;
                } catch (error) {
                    console.error('خطا در بارگذاری مدل‌ها:', error);
                    openRouterModelSelect.innerHTML = '<option value="">خطا در بارگذاری مدل‌ها</option>';
                }
            }

            function setupEventListeners() {
                creativityInput.addEventListener('input', function() {
                    creativityValue.textContent = this.value;
                });

                setupButtonSelection(formatBtns, 'format');
                setupButtonSelection(toneBtns, 'tone');
                setupButtonSelection(lengthBtns, 'length');
                setupButtonSelection(languageBtns, 'language');
                setupButtonSelection(modelBtns, 'model');

                verifyApiBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const model = this.dataset.model;
                        const apiKeyInput = document.getElementById(`api-key-${model}`);
                        const apiKey = apiKeyInput.value.trim();

                        if (!apiKey) {
                            alert('لطفاً کلید API را وارد کنید.');
                            return;
                        }

                        apiKeys[model] = apiKey;
                        localStorage.setItem(`api-key-${model}`, apiKey);
                        checkConnection(model).then(() => {
                            alert(`اتصال به ${model} ${isGeminiConnected || isOpenRouterConnected ? 'موفق' : 'ناموفق'} بود.`);
                        });
                    });
                });

                openRouterModelSelect.addEventListener('change', function() {
                    selectedOpenRouterModel = this.value;
                    if (selectedModel === 'openrouter' && selectedOpenRouterModel) {
                        connectionText.textContent = `مدل OpenRouter انتخاب‌شده: ${selectedOpenRouterModel}`;
                        setTimeout(() => updateStatus(selectedModel, isOpenRouterConnected, ''), 2000);
                    }
                });

                generateBtn.addEventListener('click', async function() {
                    await generateText(false);
                });

                compareBtn.addEventListener('click', async function() {
                    await generateText(true);
                });

                copyBtn.addEventListener('click', copyToClipboard);
                downloadPdfBtn.addEventListener('click', downloadAsPDF);
                downloadDocBtn.addEventListener('click', downloadAsDoc);
                analyzeBtn.addEventListener('click', analyzeText);
                topicInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        generateBtn.click();
                    }
                });
                clearHistoryBtn.addEventListener('click', clearHistoryPrompt);
                backupHistoryBtn.addEventListener('click', backupHistory);
                restoreHistoryBtn.addEventListener('click', restoreHistory);
                historySearch.addEventListener('input', function() {
                    renderHistory(this.value.trim().toLowerCase());
                });
                themeToggle.addEventListener('click', toggleTheme);
                colorOptionBtns.forEach(btn => btn.addEventListener('click', changeColor));
            }

            function setupButtonSelection(buttons, selectedVar) {
                buttons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        buttons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        if (selectedVar === 'format') selectedFormat = this.dataset.format;
                        else if (selectedVar === 'tone') selectedTone = this.dataset.tone;
                        else if (selectedVar === 'length') selectedLength = this.dataset.length;
                        else if (selectedVar === 'language') selectedLanguage = this.dataset.lang;
                        else if (selectedVar === 'model') {
                            selectedModel = this.dataset.model;
                            checkConnection(selectedModel);
                        }
                    });
                });
            }

            async function generateText(compareMode = false) {
                const topic = topicInput.value.trim();
                if (!topic || !selectedFormat || !selectedTone || !selectedLength) {
                    alert('لطفاً همه گزینه‌ها را پر کنید');
                    return;
                }

                const creativity = parseFloat(creativityInput.value);
                const maxWords = parseInt(maxWordsInput.value);

                const modelsToUse = compareMode ? ['lm-studio', 'gemini', 'openrouter'].filter(model => 
                    (model === 'lm-studio' && isLmConnected) || 
                    (model === 'gemini' && isGeminiConnected) || 
                    (model === 'openrouter' && isOpenRouterConnected)) : [selectedModel];

                if (modelsToUse.length === 0) {
                    alert('هیچ مدلی متصل نیست.');
                    return;
                }

                if (!compareMode && selectedModel === 'openrouter' && !selectedOpenRouterModel) {
                    alert('لطفاً یک مدل OpenRouter انتخاب کنید.');
                    return;
                }

                generateBtn.disabled = true;
                compareBtn.disabled = true;
                generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال تولید...';

                const formatNames = {
                    'essay': { fa: 'انشا', en: 'essay' },
                    'paragraph': { fa: 'پاراگراف', en: 'paragraph' },
                    'email': { fa: 'ایمیل', en: 'email' },
                    'reflection': { fa: 'اندیشه', en: 'reflection' },
                    'blog': { fa: 'پست وبلاگ', en: 'blog post' },
                    'outline': { fa: 'طرح کلی', en: 'outline' },
                    'marketing': { fa: 'تبلیغات بازاریابی', en: 'marketing advertisement' },
                    'comment': { fa: 'اظهار نظر', en: 'comment' },
                    'message': { fa: 'پیام', en: 'message' },
                    'twitter': { fa: 'توییت', en: 'tweet' }
                };

                const toneNames = {
                    'formal': { fa: 'رسمی', en: 'formal' },
                    'casual': { fa: 'گاه‌به‌گاه', en: 'casual' },
                    'professional': { fa: 'حرفه‌ای', en: 'professional' },
                    'creative': { fa: 'مشتاق', en: 'creative' },
                    'informative': { fa: 'اطلاعاتی', en: 'informative' },
                    'humorous': { fa: 'خنده‌دار', en: 'humorous' }
                };

                const lengthDescriptions = {
                    'short': { fa: 'کوتاه (حدود 100 کلمه)', en: 'short (about 100 words)' },
                    'medium': { fa: 'متوسط (حدود 400 کلمه)', en: 'medium (about 400 words)' },
                    'long': { fa: 'طولانی (بیش از 600 کلمه)', en: 'long (over 600 words)' }
                };

                const languageNames = {
                    'fa': 'فارسی',
                    'en': 'English'
                };

                const prompt = selectedLanguage === 'fa' ?
                    `موضوع: ${topic}\nقالب: ${formatNames[selectedFormat].fa}\nلحن: ${toneNames[selectedTone].fa}\nطول: ${lengthDescriptions[selectedLength].fa}\nحداکثر کلمات: ${maxWords}\n\nلطفاً یک ${formatNames[selectedFormat].fa} با لحن ${toneNames[selectedTone].fa} و طول ${lengthDescriptions[selectedLength].fa} درباره موضوع "${topic}" به زبان فارسی بنویسید.` :
                    `Topic: ${topic}\nFormat: ${formatNames[selectedFormat].en}\nTone: ${toneNames[selectedTone].en}\nLength: ${lengthDescriptions[selectedLength].en}\nMax words: ${maxWords}\n\nPlease write a ${formatNames[selectedFormat].en} with a ${toneNames[selectedTone].en} tone and ${lengthDescriptions[selectedLength].en} about the topic "${topic}" in ${languageNames[selectedLanguage]}.`;

                resultText.textContent = '';
                comparisonResults.innerHTML = '';
                comparisonResults.classList.add('d-none');
                resultContainer.classList.remove('d-none');
                resultContainer.scrollIntoView({ behavior: 'smooth' });

                abortController = new AbortController();

                try {
                    if (compareMode) {
                        const results = await Promise.all(modelsToUse.map(async model => {
                            const text = await generateWithModel(model, prompt, creativity, maxWords);
                            return { model, text };
                        }));
                        displayComparison(results);
                    } else {
                        const text = await generateWithModel(selectedModel, prompt, creativity, maxWords);
                        resultText.textContent = text;
                        saveToHistory({
                            topic: topic,
                            format: selectedFormat,
                            tone: selectedTone,
                            length: selectedLength,
                            language: selectedLanguage,
                            content: text,
                            timestamp: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    resultText.textContent = `خطا در تولید متن: ${error.message}`;
                } finally {
                    generateBtn.disabled = false;
                    compareBtn.disabled = false;
                    generateBtn.textContent = 'ایجاد پیش‌نویس';
                }
            }

            async function generateWithModel(model, prompt, creativity, maxWords) {
                if (model === 'lm-studio') {
                    return await generateWithLmStudio(prompt, creativity, maxWords);
                } else if (model === 'gemini') {
                    return await generateWithGemini(prompt, creativity, maxWords);
                } else if (model === 'openrouter') {
                    return await generateWithOpenRouter(prompt, creativity, maxWords);
                }
            }

            async function generateWithLmStudio(prompt, creativity, maxWords) {
                const response = await fetch(apiEndpoints['lm-studio'], {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        max_tokens: maxWords * 2,
                        temperature: creativity,
                        stream: true
                    }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                currentStream = reader;

                let fullText = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            const parsed = JSON.parse(data);
                            fullText += parsed.choices[0].text || '';
                            if (!comparisonResults.classList.contains('d-none')) continue;
                            resultText.textContent = fullText;
                        }
                    }
                }
                currentStream = null;
                return fullText;
            }

            async function generateWithGemini(prompt, creativity, maxWords) {
                const apiKey = apiKeys['gemini'];
                const response = await fetch(`${apiEndpoints['gemini']}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) throw new Error(`خطا در پاسخ Gemini: ${response.status}`);
                const data = await response.json();
                let fullText = data.candidates[0].content.parts[0].text || 'متن تولید نشد';

                if (fullText.split(' ').length > maxWords) {
                    fullText = fullText.split(' ').slice(0, maxWords).join(' ');
                }

                if (!comparisonResults.classList.contains('d-none')) return fullText;

                return new Promise((resolve) => {
                    let currentIndex = 0;
                    resultText.textContent = '';
                    const typeText = setInterval(() => {
                        if (currentIndex < fullText.length) {
                            resultText.textContent += fullText[currentIndex];
                            currentIndex++;
                        } else {
                            clearInterval(typeText);
                            resolve(fullText);
                        }
                    }, 20);
                });
            }

            async function generateWithOpenRouter(prompt, creativity, maxWords) {
                const apiKey = apiKeys['openrouter'];
                if (!selectedOpenRouterModel) {
                    throw new Error('لطفاً یک مدل OpenRouter انتخاب کنید');
                }

                const response = await fetch(apiEndpoints['openrouter'], {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: selectedOpenRouterModel,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: maxWords * 2,
                        temperature: creativity,
                        stream: true
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) throw new Error(`خطا در پاسخ OpenRouter: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                currentStream = reader;

                let fullText = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            try {
                                const parsed = JSON.parse(data);
                                fullText += parsed.choices[0].delta.content || '';
                                if (!comparisonResults.classList.contains('d-none')) continue;
                                resultText.textContent = fullText;
                            } catch (e) {
                                console.error('خطا در پار싱 استریم OpenRouter:', e);
                            }
                        }
                    }
                }
                currentStream = null;
                return fullText;
            }

            function displayComparison(results) {
                comparisonResults.classList.remove('d-none');
                comparisonResults.innerHTML = results.map(result => `
                    <div class="mb-3">
                        <h6>${result.model}</h6>
                        <div class="p-3 bg-light rounded">${result.text}</div>
                    </div>
                `).join('');
            }

            function copyToClipboard() {
                navigator.clipboard.writeText(resultText.textContent)
                    .then(() => {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="bi bi-check"></i> کپی شد';
                        setTimeout(() => { copyBtn.innerHTML = originalText; }, 2000);
                    })
                    .catch(err => alert('کپی متن با خطا مواجه شد.'));
            }

            function downloadAsPDF() {
                const doc = new jsPDF();
                doc.addFileToVFS('Amiri-Regular.ttf', 'https://cdn.fontcdn.ir/Font/Persian/Amiri/Amiri-Regular.ttf');
                doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
                doc.setFont('Amiri');
                doc.setFontSize(12);
                const textLines = doc.splitTextToSize(resultText.textContent, 180);
                let y = 10;
                textLines.forEach(line => {
                    doc.text(line, 190, y, { align: 'right' });
                    y += 7;
                    if (y > 280) {
                        doc.addPage();
                        y = 10;
                    }
                });
                doc.save('generated_text.pdf');
            }

            function downloadAsDoc() {
                const blob = new Blob([`\ufeff${resultText.textContent}`], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'generated_text.doc';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function analyzeText() {
                const text = resultText.textContent;
                const wordCount = text.split(/\s+/).length;
                const charCount = text.length;
                const sentenceCount = text.split(/[.!?]+/).length - 1;
                analysisResults.innerHTML = `
                    تعداد کلمات: ${wordCount}<br>
                    تعداد کاراکترها: ${charCount}<br>
                    تعداد جمله‌ها: ${sentenceCount}
                `;
                analysisResults.classList.remove('d-none');
            }

            function loadHistory() {
                const savedHistory = localStorage.getItem('textGeneratorHistory');
                if (savedHistory) {
                    historyItems = JSON.parse(savedHistory);
                    renderHistory();
                }
            }

            function saveToHistory(item) {
                historyItems.unshift(item);
                if (historyItems.length > 50) historyItems = historyItems.slice(0, 50);
                localStorage.setItem('textGeneratorHistory', JSON.stringify(historyItems));
                renderHistory();
            }

            function renderHistory(searchQuery = '') {
                if (historyItems.length === 0) {
                    noHistoryMessage.classList.remove('d-none');
                    historyList.innerHTML = '';
                    return;
                }
                noHistoryMessage.classList.add('d-none');
                historyList.innerHTML = '';
                const filteredItems = searchQuery ? 
                    historyItems.filter(item => 
                        item.topic.toLowerCase().includes(searchQuery) || 
                        item.content.toLowerCase().includes(searchQuery)) : 
                    historyItems;

                const formatNames = {
                    'essay': { fa: 'انشا', en: 'essay' },
                    'paragraph': { fa: 'پاراگراف', en: 'paragraph' },
                    'email': { fa: 'ایمیل', en: 'email' },
                    'reflection': { fa: 'اندیشه', en: 'reflection' },
                    'blog': { fa: 'پست وبلاگ', en: 'blog post' },
                    'outline': { fa: 'طرح کلی', en: 'outline' },
                    'marketing': { fa: 'تبلیغات بازاریابی', en: 'marketing advertisement' },
                    'comment': { fa: 'اظهار نظر', en: 'comment' },
                    'message': { fa: 'پیام', en: 'message' },
                    'twitter': { fa: 'توییت', en: 'tweet' }
                };
                const toneNames = {
                    'formal': { fa: 'رسمی', en: 'formal' },
                    'casual': { fa: 'گاه‌به‌گاه', en: 'casual' },
                    'professional': { fa: 'حرفه‌ای', en: 'professional' },
                    'creative': { fa: 'مشتاق', en: 'creative' },
                    'informative': { fa: 'اطلاعاتی', en: 'informative' },
                    'humorous': { fa: 'خنده‌دار', en: 'humorous' }
                };

                filteredItems.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'list-group-item history-item';
                    const date = new Date(item.timestamp);
                    const formattedDate = `${date.toLocaleDateString('fa-IR')} ${date.toLocaleTimeString('fa-IR')}`;
                    const formatName = item.language === 'fa' ? formatNames[item.format]?.fa : formatNames[item.format]?.en;
                    const toneName = item.language === 'fa' ? toneNames[item.tone]?.fa : toneNames[item.tone]?.en;
                    let contentPreview = item.content.substring(0, 100) + (item.content.length > 100 ? '...' : '');
                    if (searchQuery) {
                        const regex = new RegExp(`(${searchQuery})`, 'gi');
                        contentPreview = contentPreview.replace(regex, '<span class="highlight">$1</span>');
                    }

                    historyItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${item.topic}</h6>
                            <small class="text-muted">${formattedDate}</small>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-primary me-1">${formatName}</span>
                            <span class="badge bg-secondary me-1">${toneName}</span>
                        </div>
                        <p class="text-muted small mb-2">${contentPreview}</p>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-sm btn-outline-danger delete-history-btn me-2" data-index="${index}">
                                <i class="bi bi-trash"></i> حذف
                            </button>
                            <button class="btn btn-sm btn-outline-primary view-history-btn" data-index="${index}">
                                <i class="bi bi-eye"></i> مشاهده
                            </button>
                        </div>
                    `;

                    historyList.appendChild(historyItem);
                    historyItem.querySelector('.view-history-btn').addEventListener('click', () => viewHistoryItem(historyItems.indexOf(item)));
                    historyItem.querySelector('.delete-history-btn').addEventListener('click', () => deleteHistoryItem(historyItems.indexOf(item)));
                });
            }

            function viewHistoryItem(index) {
                const item = historyItems[index];
                resultText.textContent = item.content;
                comparisonResults.classList.add('d-none');
                resultContainer.classList.remove('d-none');
                resultContainer.scrollIntoView({ behavior: 'smooth' });
            }

            function clearHistoryPrompt() {
                if (confirm('آیا مطمئن هستید که می‌خواهید تاریخچه را پاک کنید؟')) {
                    clearHistory();
                }
            }

            function clearHistory() {
                historyItems = [];
                localStorage.removeItem('textGeneratorHistory');
                renderHistory();
            }

            function deleteHistoryItem(index) {
                if (confirm('آیا مطمئن هستید که می‌خواهید این مورد را حذف کنید؟')) {
                    historyItems.splice(index, 1);
                    localStorage.setItem('textGeneratorHistory', JSON.stringify(historyItems));
                    renderHistory();
                }
            }

            function backupHistory() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(historyItems));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "history_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            function restoreHistory() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const restoredHistory = JSON.parse(e.target.result);
                            if (Array.isArray(restoredHistory)) {
                                historyItems = restoredHistory;
                                localStorage.setItem('textGeneratorHistory', JSON.stringify(historyItems));
                                renderHistory();
                                alert('تاریخچه با موفقیت بازیابی شد.');
                            } else {
                                alert('فایل انتخاب‌شده معتبر نیست.');
                            }
                        } catch (error) {
                            alert('خطا در بازیابی تاریخچه: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeIcon.className = newTheme === 'dark' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
                colorOptions.classList.toggle('show');
            }

            function changeColor(e) {
                e.stopPropagation();
                const color = this.getAttribute('data-color');
                document.documentElement.setAttribute('data-color', color);
                localStorage.setItem('themeColor', color);
                colorOptions.classList.remove('show');
            }
        });
    </script>
</body>
</html>
