<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="light" data-color="blue">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه نویسنده هوشمند</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        @font-face {
            font-family: 'B Titr';
            src: url('https://cdn.fontcdn.ir/Font/Persian/Titr/Titr.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'B Nazanin';
            src: url('https://cdn.fontcdn.ir/Font/Persian/Nazanin/Nazanin.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: rgba(0, 0, 0, 0.05);
            --input-bg: #ffffff;
            --btn-text: #495057;
            --btn-border: #e9ecef;
            --btn-hover-bg: #f8f9fa;
            --btn-hover-border: #dee2e6;
            --btn-hover-text: #212529;
            --result-bg: #f8f9fa;
            --primary-color: #0d6efd;
            --primary-hover: #0b5ed7;
        }

        [data-theme="dark"] {
            --bg-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: #2b3035;
            --btn-text: #e9ecef;
            --btn-border: #495057;
            --btn-hover-bg: #343a40;
            --btn-hover-border: #6c757d;
            --btn-hover-text: #ffffff;
            --result-bg: #2b3035;
        }

        [data-color="blue"] { --primary-color: #0d6efd; --primary-hover: #0b5ed7; }
        [data-color="indigo"] { --primary-color: #6610f2; --primary-hover: #5b0cdd; }
        [data-color="purple"] { --primary-color: #6f42c1; --primary-hover: #643ab0; }
        [data-color="pink"] { --primary-color: #d63384; --primary-hover: #c42e76; }
        [data-color="red"] { --primary-color: #dc3545; --primary-hover: #c82333; }
        [data-color="orange"] { --primary-color: #fd7e14; --primary-hover: #e96b02; }
        [data-color="yellow"] { --primary-color: #ffc107; --primary-hover: #e0a800; }
        [data-color="green"] { --primary-color: #198754; --primary-hover: #157347; }
        [data-color="teal"] { --primary-color: #20c997; --primary-hover: #1ba87e; }
        [data-color="cyan"] { --primary-color: #0dcaf0; --primary-hover: #0bb2d4; }
        [data-color="gray"] { --primary-color: #6c757d; --primary-hover: #5a6268; }
        [data-color="dark"] { --primary-color: #343a40; --primary-hover: #23272b; }

        body {
            font-family: 'Vazirmatn', 'B Nazanin', 'Tahoma', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            padding: 0;
            margin: 0;
        }

        h1, h2, h3, h4, h5, h6, .card-header, .btn, #generate-btn {
            font-family: 'B Titr', 'Vazirmatn', 'Tahoma', sans-serif;
            letter-spacing: 0.5px;
        }

        p, div, span, input, textarea, label, .form-control, #result-text, .history-item {
            font-family: 'B Nazanin', 'Vazirmatn', 'Tahoma', sans-serif;
            letter-spacing: 0.3px;
        }

        .card {
            border-radius: 10px;
            border: none;
            overflow: hidden;
            background-color: var(--card-bg);
            transition: background-color 0.3s ease;
        }

        .card-header {
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg) !important;
        }

        .btn-outline-secondary {
            border-color: var(--btn-border);
            color: var(--btn-text);
        }

        .btn-outline-secondary:hover {
            background-color: var(--btn-hover-bg);
            border-color: var(--btn-hover-border);
            color: var(--btn-hover-text);
        }

        .btn-outline-secondary.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .connected { background-color: #28a745; box-shadow: 0 0 5px #28a745; }
        .disconnected { background-color: #dc3545; box-shadow: 0 0 5px #dc3545; }
        .connecting {
            background-color: #ffc107;
            box-shadow: 0 0 5px #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        #result-text {
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.8;
            background-color: var(--result-bg) !important;
        }

        .format-btn.active, .tone-btn.active, .length-btn.active, .language-btn.active, .model-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        #history-container { margin-bottom: 2rem; }

        .history-item {
            transition: background-color 0.2s;
            border-left: none;
            border-right: none;
        }

        .history-item:hover { background-color: rgba(0, 0, 0, 0.02); }
        [data-theme="dark"] .history-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .history-item:first-child { border-top: none; }
        .badge { font-weight: normal; }

        .theme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover { transform: scale(1.1); }

        .color-options {
            display: none;
            flex-wrap: wrap;
            gap: 5px;
            width: 150px;
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .color-options.show { display: flex; }

        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-option:hover { transform: scale(1.2); }

        [data-theme="dark"] .text-muted { color: #adb5bd !important; }
        [data-theme="dark"] small { color: #ced4da !important; }
        [data-theme="dark"] .btn-outline-danger { color: #f8d7da; border-color: #dc3545; }
        [data-theme="dark"] .btn-outline-primary { color: #cfe2ff; border-color: var(--primary-color); }
        [data-theme="dark"] .btn-outline-success { color: #d1e7dd; border-color: #198754; }
        [data-theme="dark"] .btn-outline-secondary { color: #e9ecef; border-color: #6c757d; }
        [data-theme="dark"] .card-header h5,
        [data-theme="dark"] .card-header h1,
        [data-theme="dark"] label,
        [data-theme="dark"] .form-label,
        [data-theme="dark"] .mb-0 { color: #e9ecef; }
        [data-theme="dark"] #result-text { color: #e9ecef; }
        [data-theme="dark"] .form-control {
            color: #e9ecef;
            background-color: var(--input-bg);
            border-color: var(--border-color);
        }

        .container {
            padding: 15px;
            max-width: 100%;
        }

        .model-api-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .api-key-input {
            flex-grow: 1;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .col-md-6.offset-md-3 {
                padding: 0 10px;
                width: 100%;
            }
            .card { border-radius: 8px; }
            .btn { padding: 0.375rem 0.5rem; font-size: 0.875rem; }
            .theme-switcher { top: 10px; right: 10px; }
            .model-api-container { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h1 class="text-center mb-0 fw-bold">نوشتن خلاق</h1>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label for="topic" class="form-label">موضوعی که می‌خواهید بنویسید</label>
                            <textarea id="topic" class="form-control" rows="3" placeholder="برای ایجاد پیش‌نویس، Enter را فشار دهید"></textarea>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-layout-text-window me-2"></i>
                                <h5 class="mb-0">قالب</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary format-btn" data-format="essay">انشا</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="paragraph">پاراگراف</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="email">پست الکترونیکی</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="reflection">اندیشه</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="blog">پست وبلاگ</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="outline">طرح کلی</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="marketing">تبلیغات بازاریابی</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="comment">اظهار نظر</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="message">پیام</button>
                                <button class="btn btn-outline-secondary format-btn" data-format="twitter">توییت</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-emoji-smile me-2"></i>
                                <h5 class="mb-0">لحن</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary tone-btn" data-tone="formal">رسمی</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="casual">گاه‌به‌گاه</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="professional">حرفه‌ای</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="creative">مشتاق</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="informative">اطلاعاتی</button>
                                <button class="btn btn-outline-secondary tone-btn" data-tone="humorous">خنده‌دار</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-text-paragraph me-2"></i>
                                <h5 class="mb-0">طول</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary length-btn" data-length="short">کوتاه</button>
                                <button class="btn btn-outline-secondary length-btn" data-length="medium">متوسط</button>
                                <button class="btn btn-outline-secondary length-btn" data-length="long">طولانی</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-translate me-2"></i>
                                <h5 class="mb-0">زبان</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary language-btn active" data-lang="fa">فارسی</button>
                                <button class="btn btn-outline-secondary language-btn" data-lang="en">English</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-robot me-2"></i>
                                <h5 class="mb-0">مدل هوش مصنوعی</h5>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary model-btn active" data-model="lm-studio">LM Studio <span class="status-dot" id="status-lm-studio"></span></button>
                                <button class="btn btn-outline-secondary model-btn" data-model="gemini">Gemini <span class="status-dot" id="status-gemini"></span></button>
                                <button class="btn btn-outline-secondary model-btn" data-model="openrouter">OpenRouter <span class="status-dot" id="status-openrouter"></span></button>
                            </div>
                            <div class="mt-3">
                                <div class="model-api-container">
                                    <input type="text" id="api-key-gemini" class="form-control api-key-input" placeholder="کلید API برای Gemini">
                                    <button class="btn btn-sm btn-primary verify-api-btn" data-model="gemini">تأیید</button>
                                </div>
                                <div class="model-api-container">
                                    <input type="text" id="api-key-openrouter" class="form-control api-key-input" placeholder="کلید API برای OpenRouter">
                                    <button class="btn btn-sm btn-primary verify-api-btn" data-model="openrouter">تأیید</button>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button id="generate-btn" class="btn btn-primary py-3 fw-bold">ایجاد پیش‌نویس</button>
                        </div>

                        <div class="mt-3 d-flex align-items-center">
                            <div class="connection-status me-2">
                                <span id="status-indicator" class="status-dot disconnected"></span>
                            </div>
                            <small id="connection-text">اتصال به مدل هوش مصنوعی: قطع</small>
                        </div>
                    </div>
                </div>

                <div id="result-container" class="card shadow-sm mt-4 d-none">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">نتیجه:</h5>
                        <button id="copy-btn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-clipboard"></i> کپی</button>
                    </div>
                    <div class="card-body">
                        <div id="result-text" class="p-3 bg-light rounded"></div>
                    </div>
                </div>
            </div>

            <div id="history-container" class="card shadow-sm mt-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">تاریخچه</h5>
                    <div>
                        <button id="clear-history-btn" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> پاک کردن</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="history-list" class="list-group list-group-flush">
                        <div class="list-group-item text-center text-muted py-4" id="no-history-message">تاریخچه‌ای موجود نیست</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="theme-switcher">
        <button class="theme-toggle" id="theme-toggle">
            <i class="bi bi-sun-fill" id="theme-icon"></i>
        </button>
        <div class="color-options" id="color-options">
            <div class="color-option" data-color="blue" style="background-color: #0d6efd;"></div>
            <div class="color-option" data-color="red" style="background-color: #dc3545;"></div>
            <div class="color-option" data-color="green" style="background-color: #198754;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const topicInput = document.getElementById('topic');
            const generateBtn = document.getElementById('generate-btn');
            const resultContainer = document.getElementById('result-container');
            const resultText = document.getElementById('result-text');
            const copyBtn = document.getElementById('copy-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const connectionText = document.getElementById('connection-text');
            const formatBtns = document.querySelectorAll('.format-btn');
            const toneBtns = document.querySelectorAll('.tone-btn');
            const lengthBtns = document.querySelectorAll('.length-btn');
            const languageBtns = document.querySelectorAll('.language-btn');
            const modelBtns = document.querySelectorAll('.model-btn');
            const verifyApiBtns = document.querySelectorAll('.verify-api-btn');
            const historyList = document.getElementById('history-list');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const noHistoryMessage = document.getElementById('no-history-message');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const colorOptions = document.getElementById('color-options');
            const colorOptionBtns = document.querySelectorAll('.color-option');

            let selectedFormat = '';
            let selectedTone = '';
            let selectedLength = '';
            let selectedLanguage = 'fa';
            let selectedModel = 'lm-studio';
            let historyItems = [];
            let apiKeys = {
                'gemini': localStorage.getItem('api-key-gemini') || '',
                'openrouter': localStorage.getItem('api-key-openrouter') || ''
            };
            let isLmConnected = false;
            let isGeminiConnected = false;
            let isOpenRouterConnected = false;
            let currentStream = null;
            let abortController = null;

            const apiEndpoints = {
                'lm-studio': 'http://localhost:1234/v1/completions',
                'gemini': 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
                'openrouter': 'https://openrouter.ai/api/v1/chat/completions'
            };

            // Load saved API keys into inputs
            document.getElementById('api-key-gemini').value = apiKeys['gemini'];
            document.getElementById('api-key-openrouter').value = apiKeys['openrouter'];

            // Initial connection check
            checkAllConnections();

            async function checkConnection(model) {
                const statusDot = document.getElementById(`status-${model}`);
                statusDot.className = 'status-dot connecting';

                if (model === 'lm-studio') {
                    try {
                        const response = await fetch('http://localhost:1234/v1/models');
                        if (response.ok) {
                            isLmConnected = true;
                            statusDot.className = 'status-dot connected';
                            updateStatus(model, true, 'اتصال موفق');
                        } else {
                            throw new Error('اتصال برقرار نشد');
                        }
                    } catch (error) {
                        isLmConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'عدم اتصال به LM Studio');
                    }
                } else if (model === 'gemini') {
                    const apiKey = apiKeys['gemini'];
                    if (!apiKey) {
                        isGeminiConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'کلید API Gemini وارد نشده');
                        return;
                    }
                    try {
                        const response = await fetch(`${apiEndpoints[model]}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: 'تست' }] }] })
                        });
                        if (response.ok) {
                            isGeminiConnected = true;
                            statusDot.className = 'status-dot connected';
                            updateStatus(model, true, 'اتصال موفق');
                        } else {
                            throw new Error('اتصال برقرار نشد');
                        }
                    } catch (error) {
                        isGeminiConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'عدم اتصال به Gemini');
                    }
                } else if (model === 'openrouter') {
                    const apiKey = apiKeys['openrouter'];
                    if (!apiKey) {
                        isOpenRouterConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'کلید API OpenRouter وارد نشده');
                        return;
                    }
                    try {
                        const response = await fetch('https://openrouter.ai/api/v1/models', {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${apiKey}` }
                        });
                        if (response.ok) {
                            isOpenRouterConnected = true;
                            statusDot.className = 'status-dot connected';
                            updateStatus(model, true, 'اتصال موفق');
                        } else {
                            throw new Error('اتصال برقرار نشد');
                        }
                    } catch (error) {
                        isOpenRouterConnected = false;
                        statusDot.className = 'status-dot disconnected';
                        updateStatus(model, false, 'عدم اتصال به OpenRouter');
                    }
                }
            }

            function updateStatus(model, isConnected, message) {
                if (model === selectedModel) {
                    statusIndicator.className = `status-dot ${isConnected ? 'connected' : 'disconnected'}`;
                    connectionText.textContent = `اتصال به مدل هوش مصنوعی: ${isConnected ? 'متصل' : `قطع - ${message}`}`;
                }
            }

            function checkAllConnections() {
                checkConnection('lm-studio');
                checkConnection('gemini');
                checkConnection('openrouter');
                setInterval(() => {
                    checkConnection('lm-studio');
                    checkConnection('gemini');
                    checkConnection('openrouter');
                }, 20000);
            }

            loadHistory();

            function setupButtonSelection(buttons, selectedVar) {
                buttons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        buttons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        if (selectedVar === 'format') selectedFormat = this.dataset.format;
                        else if (selectedVar === 'tone') selectedTone = this.dataset.tone;
                        else if (selectedVar === 'length') selectedLength = this.dataset.length;
                        else if (selectedVar === 'language') selectedLanguage = this.dataset.lang;
                        else if (selectedVar === 'model') {
                            selectedModel = this.dataset.model;
                            checkConnection(selectedModel);
                        }
                    });
                });
            }

            setupButtonSelection(formatBtns, 'format');
            setupButtonSelection(toneBtns, 'tone');
            setupButtonSelection(lengthBtns, 'length');
            setupButtonSelection(languageBtns, 'language');
            setupButtonSelection(modelBtns, 'model');

            verifyApiBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const model = this.dataset.model;
                    const apiKeyInput = document.getElementById(`api-key-${model}`);
                    const apiKey = apiKeyInput.value.trim();

                    if (!apiKey) {
                        alert('لطفاً کلید API را وارد کنید.');
                        return;
                    }

                    apiKeys[model] = apiKey;
                    localStorage.setItem(`api-key-${model}`, apiKey);
                    checkConnection(model).then(() => {
                        alert(`اتصال به ${model} ${isGeminiConnected || isOpenRouterConnected ? 'موفق' : 'ناموفق'} بود.`);
                    });
                });
            });

            generateBtn.addEventListener('click', async function() {
                const topic = topicInput.value.trim();
                if (!topic || !selectedFormat || !selectedTone || !selectedLength) {
                    alert('لطفاً همه گزینه‌ها را پر کنید');
                    return;
                }

                const isConnected = selectedModel === 'lm-studio' ? isLmConnected : 
                                   selectedModel === 'gemini' ? isGeminiConnected : 
                                   isOpenRouterConnected;
                if (!isConnected) {
                    alert('اتصال به مدل انتخاب‌شده برقرار نیست.');
                    return;
                }

                generateBtn.disabled = true;
                generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال تولید...';

                const formatNames = {
                    'essay': { fa: 'انشا', en: 'essay' },
                    'paragraph': { fa: 'پاراگراف', en: 'paragraph' },
                    'email': { fa: 'ایمیل', en: 'email' },
                    'reflection': { fa: 'اندیشه', en: 'reflection' },
                    'blog': { fa: 'پست وبلاگ', en: 'blog post' },
                    'outline': { fa: 'طرح کلی', en: 'outline' },
                    'marketing': { fa: 'تبلیغات بازاریابی', en: 'marketing advertisement' },
                    'comment': { fa: 'اظهار نظر', en: 'comment' },
                    'message': { fa: 'پیام', en: 'message' },
                    'twitter': { fa: 'توییت', en: 'tweet' }
                };

                const toneNames = {
                    'formal': { fa: 'رسمی', en: 'formal' },
                    'casual': { fa: 'گاه‌به‌گاه', en: 'casual' },
                    'professional': { fa: 'حرفه‌ای', en: 'professional' },
                    'creative': { fa: 'مشتاق', en: 'creative' },
                    'informative': { fa: 'اطلاعاتی', en: 'informative' },
                    'humorous': { fa: 'خنده‌دار', en: 'humorous' }
                };

                const lengthDescriptions = {
                    'short': { fa: 'کوتاه (حدود 100 کلمه)', en: 'short (about 100 words)' },
                    'medium': { fa: 'متوسط (حدود 400 کلمه)', en: 'medium (about 400 words)' },
                    'long': { fa: 'طولانی (بیش از 600 کلمه)', en: 'long (over 600 words)' }
                };

                const languageNames = {
                    'fa': 'فارسی',
                    'en': 'English'
                };

                const prompt = selectedLanguage === 'fa' ?
                    `موضوع: ${topic}\nقالب: ${formatNames[selectedFormat].fa}\nلحن: ${toneNames[selectedTone].fa}\nطول: ${lengthDescriptions[selectedLength].fa}\n\nلطفاً یک ${formatNames[selectedFormat].fa} با لحن ${toneNames[selectedTone].fa} و طول ${lengthDescriptions[selectedLength].fa} درباره موضوع "${topic}" به زبان فارسی بنویسید.` :
                    `Topic: ${topic}\nFormat: ${formatNames[selectedFormat].en}\nTone: ${toneNames[selectedTone].en}\nLength: ${lengthDescriptions[selectedLength].en}\n\nPlease write a ${formatNames[selectedFormat].en} with a ${toneNames[selectedTone].en} tone and ${lengthDescriptions[selectedLength].en} about the topic "${topic}" in ${languageNames[selectedLanguage]}.`;

                resultText.textContent = '';
                resultContainer.classList.remove('d-none');
                resultContainer.scrollIntoView({ behavior: 'smooth' });

                abortController = new AbortController();

                try {
                    if (selectedModel === 'lm-studio') {
                        await generateWithLmStudio(prompt);
                    } else if (selectedModel === 'gemini') {
                        await generateWithGemini(prompt);
                    } else if (selectedModel === 'openrouter') {
                        await generateWithOpenRouter(prompt);
                    }
                } catch (error) {
                    resultText.textContent = `خطا در تولید متن: ${error.message}`;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ایجاد پیش‌نویس';
                    if (resultText.textContent.trim() !== '') {
                        saveToHistory({
                            topic: topic,
                            format: selectedFormat,
                            tone: selectedTone,
                            length: selectedLength,
                            language: selectedLanguage,
                            content: resultText.textContent,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            });

            async function generateWithLmStudio(prompt) {
                const response = await fetch(apiEndpoints['lm-studio'], {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        max_tokens: selectedLength === 'short' ? 200 : (selectedLength === 'medium' ? 800 : 1200),
                        temperature: 0.7,
                        stream: true
                    }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                currentStream = reader;

                let fullText = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            const parsed = JSON.parse(data);
                            fullText += parsed.choices[0].text || '';
                            resultText.textContent = fullText;
                        }
                    }
                }
                currentStream = null;
            }

            async function generateWithGemini(prompt) {
                const apiKey = apiKeys['gemini'];
                const response = await fetch(`${apiEndpoints['gemini']}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) throw new Error(`خطا در پاسخ Gemini: ${response.status}`);
                const data = await response.json();
                resultText.textContent = data.candidates[0].content.parts[0].text || 'متن تولید نشد';
            }

            async function generateWithOpenRouter(prompt) {
                const apiKey = apiKeys['openrouter'];
                const response = await fetch(apiEndpoints['openrouter'], {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: selectedLength === 'short' ? 200 : (selectedLength === 'medium' ? 800 : 1200),
                        stream: true
                    }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                currentStream = reader;

                let fullText = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            const parsed = JSON.parse(data);
                            fullText += parsed.choices[0].delta.content || '';
                            resultText.textContent = fullText;
                        }
                    }
                }
                currentStream = null;
            }

            copyBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(resultText.textContent)
                    .then(() => {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="bi bi-check"></i> کپی شد';
                        setTimeout(() => { copyBtn.innerHTML = originalText; }, 2000);
                    })
                    .catch(err => alert('کپی متن با خطا مواجه شد.'));
            });

            topicInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    generateBtn.click();
                }
            });

            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('آیا مطمئن هستید که می‌خواهید تاریخچه را پاک کنید؟')) {
                    clearHistory();
                }
            });

            function loadHistory() {
                const savedHistory = localStorage.getItem('textGeneratorHistory');
                if (savedHistory) {
                    historyItems = JSON.parse(savedHistory);
                    renderHistory();
                }
            }

            function saveToHistory(item) {
                historyItems.unshift(item);
                if (historyItems.length > 50) historyItems = historyItems.slice(0, 50);
                localStorage.setItem('textGeneratorHistory', JSON.stringify(historyItems));
                renderHistory();
            }

            function renderHistory() {
                if (historyItems.length === 0) {
                    noHistoryMessage.classList.remove('d-none');
                    return;
                }
                noHistoryMessage.classList.add('d-none');
                historyList.innerHTML = '';
                const formatNames = {
                    'essay': { fa: 'انشا', en: 'essay' },
                    'paragraph': { fa: 'پاراگراف', en: 'paragraph' },
                    'email': { fa: 'ایمیل', en: 'email' },
                    'reflection': { fa: 'اندیشه', en: 'reflection' },
                    'blog': { fa: 'پست وبلاگ', en: 'blog post' },
                    'outline': { fa: 'طرح کلی', en: 'outline' },
                    'marketing': { fa: 'تبلیغات بازاریابی', en: 'marketing advertisement' },
                    'comment': { fa: 'اظهار نظر', en: 'comment' },
                    'message': { fa: 'پیام', en: 'message' },
                    'twitter': { fa: 'توییت', en: 'tweet' }
                };
                const toneNames = {
                    'formal': { fa: 'رسمی', en: 'formal' },
                    'casual': { fa: 'گاه‌به‌گاه', en: 'casual' },
                    'professional': { fa: 'حرفه‌ای', en: 'professional' },
                    'creative': { fa: 'مشتاق', en: 'creative' },
                    'informative': { fa: 'اطلاعاتی', en: 'informative' },
                    'humorous': { fa: 'خنده‌دار', en: 'humorous' }
                };

                historyItems.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'list-group-item history-item';
                    const date = new Date(item.timestamp);
                    const formattedDate = `${date.toLocaleDateString('fa-IR')} ${date.toLocaleTimeString('fa-IR')}`;
                    const formatName = item.language === 'fa' ? formatNames[item.format]?.fa : formatNames[item.format]?.en;
                    const toneName = item.language === 'fa' ? toneNames[item.tone]?.fa : toneNames[item.tone]?.en;
                    const contentPreview = item.content.substring(0, 100) + (item.content.length > 100 ? '...' : '');

                    historyItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${item.topic}</h6>
                            <small class="text-muted">${formattedDate}</small>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-primary me-1">${formatName}</span>
                            <span class="badge bg-secondary me-1">${toneName}</span>
                        </div>
                        <p class="text-muted small mb-2">${contentPreview}</p>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-sm btn-outline-danger delete-history-btn me-2" data-index="${index}">
                                <i class="bi bi-trash"></i> حذف
                            </button>
                            <button class="btn btn-sm btn-outline-primary view-history-btn" data-index="${index}">
                                <i class="bi bi-eye"></i> مشاهده
                            </button>
                        </div>
                    `;

                    historyList.appendChild(historyItem);
                    historyItem.querySelector('.view-history-btn').addEventListener('click', () => viewHistoryItem(index));
                    historyItem.querySelector('.delete-history-btn').addEventListener('click', () => deleteHistoryItem(index));
                });
            }

            function viewHistoryItem(index) {
                const item = historyItems[index];
                resultText.textContent = item.content;
                resultContainer.classList.remove('d-none');
                resultContainer.scrollIntoView({ behavior: 'smooth' });
            }

            function clearHistory() {
                historyItems = [];
                localStorage.removeItem('textGeneratorHistory');
                renderHistory();
            }

            function deleteHistoryItem(index) {
                if (confirm('آیا مطمئن هستید که می‌خواهید این مورد را حذف کنید؟')) {
                    historyItems.splice(index, 1);
                    localStorage.setItem('textGeneratorHistory', JSON.stringify(historyItems));
                    renderHistory();
                }
            }

            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeIcon.className = newTheme === 'dark' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
                colorOptions.classList.toggle('show');
            });

            colorOptionBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const color = this.getAttribute('data-color');
                    document.documentElement.setAttribute('data-color', color);
                    localStorage.setItem('themeColor', color);
                    colorOptions.classList.remove('show');
                });
            });
        });
    </script>
</body>
</html>